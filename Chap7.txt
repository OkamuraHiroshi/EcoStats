### 7章　個体群動態評価のための統計モデル

## 7 - 1 線形モデルを利用した個体群の評価

library(tidyverse)       # tidyverseパッケージの読み込み
saiga <- read_csv("Saiga_antelope.csv")        # サイガ個体群データの読み込み

dat1 <- saiga %>% mutate_at(-(1:28), as.numeric) %>% pivot_longer(cols=starts_with("X"), names_prefix="X", names_to="Year",values_to="Pop") %>% mutate_at(vars(Year), as.numeric) %>% mutate_at(vars(Location), as.factor)        # サイガ個体群データを分析しやすいように整形
tapply(dat1$Pop, dat1$Location, function(x) sum(!is.na(x)))       # 生息場所ごとに個体数カウントがいくつあるかを表示

dat_kk <- subset(dat1, Location=="Kalmykia, Kazakhstan")      # カルムイク/カザフスタンのサイガ個体群データを抽出

year <- dat_kk$Year[which(!is.na(dat_kk$Pop))]       # データがある年だけを抽出
dat_kk$T <- dat_kk$Year - (min(year)-1)         # 年ラベルを数字に置換（データがある最初の年を1とする）
dat_kk <- dat_kk %>% mutate(Y=log(Pop)/sqrt(T), X1=sqrt(T), X2=1/sqrt(T))        # 線形回帰のためにデータを整形
mod <- lm(Y ~ X1 + X2 - 1, data=dat_kk)       # 線形回帰を実行
( parms <- c(r = as.numeric(exp(mod$coef[1])), N0 = as.numeric(exp(mod$coef[2]))) )      # 回帰係数から増加率と初期個体数を計算

r <- parms["r"]       # 増加率
N0 <- parms["N0"]       # 初期個体数
dat_kk$Pred <- exp((log(r)*dat_kk$X1+log(N0)*dat_kk$X2)*dat_kk$X1)        # モデルによる予測個体数を計算

ggplot(dat_kk, aes(x=Year, y=Pop))+geom_point()+geom_line(aes(x=Year, y=Pred), color="blue", linetype="dashed")+labs(y="Population Size", title=dat_kk$Location[1])+theme_bw()       # 個体数の観測値と回帰モデルによる予測値を比較するプロット

dat_uk <- subset(dat1, Location=="Ustiurt, Kazakhstan")       # ウスチュルト高原/カザフスタンのサイガ個体群データ
year <- dat_uk$Year[which(!is.na(dat_uk$Pop))]        # データがある年だけを抽出
dat_uk$T <- dat_uk$Year - (min(year)-1)          # データがある最初の年を1にする変換
dat_uk <- dat_uk %>% mutate(Y=log(Pop)/sqrt(T), X1=sqrt(T), X2=1/sqrt(T))       # 回帰のためのデータの整形
mod_uk <- lm(Y ~ X1 + X2 - 1, data=dat_uk)        # 線形回帰を適用
r_uk <- exp(mod_uk$coef[1])        # 増加率
N0_uk <- exp(mod_uk$coef[2])        # 初期個体数
dat_uk$Pred <- exp((log(r_uk)*dat_uk$X1+log(N0_uk)*dat_uk$X2)*dat_uk$X1)        # 予測値を計算
ggplot(dat_uk, aes(x=Year, y=Pop))+geom_point()+geom_line(aes(x=Year, y=Pred), color="blue", linetype="dashed")+labs(y="Population Size", title=dat_uk$Location[1])+theme_bw()        # 個体数の観測値と予測値をプロット

## 7 - 2 個体数の将来予測と絶滅確率の推定

var_saiga <- function(T) t(c(T, 1))%*%vcov(mod)%*%c(T, 1)+T*summary(mod)$sigma^2       # T年の対数個体数推定値の分散を計算する関数（デルタ法）
future_saiga <- function(T,N=1){
  pnorm(log(N), log(r)*T+log(N0), sqrt(var_saiga(T)))       # T年の対数個体数推定値と分散を与えたとき，個体数log(N)より小さくなる確率を計算
}
T_obs <- last(dat_kk$T[!is.na(dat_kk$Pop)])        # 個体数観測値が有効な年を抽出
Prob_extinction <- sapply(c(16,26,100),function(t) future_saiga(t+T_obs,N=1))        # 16年後，26年後，100年後，個体数が閾値（N=1）を下回る確率を計算
names(Prob_extinction) <- paste0("Time = ",c(16,26,100))       # 絶滅確率の結果の名前を設定
Prob_extinction        # 絶滅確率計算結果を表示

P_ext <- NULL
for (N in c(1,50,500,5000)){
  Prob_extinction <- sapply(c(16,26,100),function(t) future_saiga(t+T_obs,N=N))
  P_ext <- rbind(P_ext, Prob_extinction)
}
colnames(P_ext) <- paste0("Time = ",c(16,26,100))
rownames(P_ext) <- paste0("N* = ",c(1,50,500,5000))
P_ext
