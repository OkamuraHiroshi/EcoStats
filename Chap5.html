<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
 
<body>

## 5 - 1  非線形回帰

library(fishmethods)       # fishmethodsパッケージを読み込み
library(tidyverse)        # tidyverseパッケージを読み込み
data(pinfish)          # fishmethodsパッケージ内のpinfishデータを読み込み
dat <- pinfish           # pinfishデータをdatにコピー
p1 <- ggplot(dat, aes(x=age, y=sl)) + geom_point() + labs(x="Age", y="Lengh") + theme_bw()       # ggplotによって年齢に対する体長のプロットを作成
print(p1)       # ggplotで作った図を表示

mod <- nls(sl~Linf*(1-exp(-K*(age-a0))),data=dat,start=list(Linf=250,K=0.5,a0=0))        # von Bertalanffyの成長曲線のフィット
parms <- summary(mod)$coefficients[,1]        # 成長曲線のパラメータの推定値
Linf <- parms[1]; K <- parms[2]; a0 <- parms[3]        # 推定パラメータを分かりやすい名前の変数に代入
vB <- Linf*(1-exp(-K*(dat$age-a0)))        # 体長の予測値を計算
p2 <- p1 + geom_line(aes(x=age, y=vB), color="blue", linewidth=1.5)       # 上で作った図p1に成長曲線による予測値を追加
print(p2)        # 図の描画

mod2 <- nls(log(sl)~log(Linf)+log(1-exp(-K*(age-a0))),data=dat,start=list(Linf=250,K=0.5,a0=0))        # 体長そのままではなく，対数変換したものにモデルを適用
parms <- summary(mod2)$coefficients[,1]       # 成長曲線のパラメータの推定値
Linf <- parms[1]; K <- parms[2]; a0 <- parms[3]        # 推定パラメータを分かりやすい名前の変数に代入
vB2 <- Linf*(1-exp(-K*(dat$age-a0)))        # 体長の予測値を計算        
p3 <- p2 + geom_line(aes(x=age, y=vB2), color="blue", linetype="dashed", linewidth=1.5)       # 上で作った図p2に対数変換したものに正規分布誤差を仮定した成長曲線による予測値を追加
print(p3)        # 図の描画

## 5 - 2 一般化加法モデル

set.seed(666)      # 乱数のseedを設定
xmax <- 5       # xの最大値
x <- 0:xmax       # xは0から5まで
n <- length(x)     # xの要素数
y <- rnorm(n,0,1)      # yはxの要素数と同じで，xとは独立に，標準正規分布から作成
mod <- lm(y~poly(x,degree=n-1,raw=TRUE))       # yに対してxのn-1次の多項式回帰をフィット 
xx <- seq(0,xmax,by=0.1)         # グラフ描画のためにx軸の値を細かく作成
pred <- predict(mod, newdata=list(x=xx))         # 上のxxに対して予測値を計算
dat <- data.frame(x=x,y=y)        # xとyの組をdatとする
dat_p <- data.frame(x=xx,p=pred)      # xxとpredの組をdat_pとする
p1 <- ggplot(dat,aes(x=x,y=y))+geom_point()+geom_line(data=dat_p,aes(x=x,y=p))+theme_bw()      # xとyの散布図に多項式回帰の曲線を上描き
print(p1)      # 図を描画（データに完全にあてはまっている）

fit_sp <- spline(x,y)       # x，yにスプライン曲線をフィット
dat_sp <- data.frame(x=fit_sp$x,y=fit_sp$y)      #  スプライン曲線フィット結果のデータを作成
p2 <- p1 + geom_line(aes(x=x,y=y),linetype="dotted")+geom_line(data=dat_sp,aes(x=x,y=y),linetype="dashed",color="blue")        # 観測点をつないだものとスプライン曲線フィットの結果を上描き
print(p2)       # 図の描画

library(mgcv)       # mgcvパッケージの読み込み
library(tidymv)       # tidyverse用にmgcv::gamの予測値などを扱うためのパッケージ
library(pscl)       # psclパッケージの読み込み
data(prussian)       # prussianデータの読み込み
dat <- prussian       # datにprussianをコピー
res <- gam(y~s(year), data=dat, family=poisson)       # 年を説明変数としてポアソン分布を誤差分布とするgamをフィット 
pred <- predict_gam(res)         # 予測値の作成（predict_gamはtidymvパッケージの関数）
dat2 <- dat %>% group_by(year) %>% summarize(mean_y=mean(y))        # 年ごとの死亡者数の平均値のデータを作成
ggplot(pred, aes(x=year, y=exp(fit)))+geom_line()+geom_point(data=dat2,aes(x=year,y=mean_y))+labs(x="Year",y="Predicted Value")+theme_bw()      # gamによる予測結果の曲線と観測データを同時にプロットして比較

## 5 - 4 樹木モデル

library(rpart)       # rpartパッケージの読み込み
library(rpart.plot)       # rpart.plotパッケージの読み込み
library(MASS)       # MASSパッケージの読み込み
data(cats)       # catsデータの読み込み
dat <- cats        # datにcatsデータをコピー
(res_dt <- rpart(Sex ~ Bwt, data=dat, method="class", parms=list(split="gini"), control=list(maxdepth=1)))         # datの性別を体重量で予測するtreeモデル

set.seed(13)       # 乱数発生のseed設定
n <- nrow(dat)        # datのサンプルサイズ
train <- sample(n,round(n*0.8))       # nのうちランダムに選んだ80%をトレーニングデータとする
dat_train <- dat[train,]      # トレーニングデータ
dat_test <- dat[-train,]      # テストデータ
(res_dt <- rpart(Sex ~ Bwt + Hwt, data=dat_train,　method="class", parms=list(split="gini"),control=list(maxdepth=30)))        # 性別を体重と心臓重量で予測するtreeモデル
rpart.plot(res_dt)        # treeによる分類結果を描画

printcp(res_dt)       # cross validationによる最適なCP
plotcp(res_dt)       # cross validationによるCPの変化プロット（CPは値の区間の幾何平均が使われているのでprintcpの値と違っている）

library(pROC)       # pROCパッケージを読み込む
pred_dt <- predict(res_dt,dat_test,type="prob")        #
roc_dt <- roc(dat_test$Sex, as.numeric(pred_dt[,2]))
ggroc(roc_dt,legacy.axes=TRUE)+xlab("FPR")+ylab("TPR")+ggtitle(paste("AUC =",round(roc_dt$auc,2)))+geom_segment(aes(x=0, xend=1, y=0, yend=1), color="blue", linetype="dashed")+theme_bw()

mod <- list()
par(mfrow=c(1,2))

for (i in 1:2){
  train <- sample(n,round(4/5*n))
  dat_train <- dat[train,]
  mod[[i]] <- rpart(Sex~Bwt+Hwt,data=dat_train,method="class")
  rpart.plot(mod[[i]])
}

## 5 - 5 ランダムフォレスト


</body>
</html>
